name: Global CI/CD Orchestrator

on:
  push:
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/**'
  pull_request:
    branches: [ main ]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  packages: write

jobs:
  # Reuse the change detection workflow
  changes:
    name: Detect Changes
    uses: ./.github/workflows/change-detection.yml

  # Trigger backend workflow if backend changes detected
  trigger-backend:
    name: Trigger Backend CI
    needs: changes
    if: |
      needs.changes.outputs.backend == 'true' ||
      github.ref == 'refs/heads/main' ||
      github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/backend-ci.yml

  # Trigger frontend workflow if frontend changes detected
  trigger-frontend:
    name: Trigger Frontend CI
    needs: changes
    if: |
      needs.changes.outputs.frontend == 'true' ||
      github.ref == 'refs/heads/main' ||
      github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/frontend-ci.yml

  # Summary job that runs after all component workflows
  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [changes, trigger-backend, trigger-frontend]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Generate summary
        run: |
          echo "# CI/CD Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Components Processed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.changes.outputs.backend }}" == "true" ]]; then
            echo "- ✅ Backend changes detected and processed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ℹ️ No backend changes detected" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.changes.outputs.frontend }}" == "true" ]]; then
            echo "- ✅ Frontend changes detected and processed" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ℹ️ No frontend changes detected" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Workflow Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ needs.trigger-backend.result }}" == "success" || "${{ needs.trigger-backend.result }}" == "skipped" ]]; then
            echo "- ✅ Backend workflow: ${{ needs.trigger-backend.result }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Backend workflow: ${{ needs.trigger-backend.result }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.trigger-frontend.result }}" == "success" || "${{ needs.trigger-frontend.result }}" == "skipped" ]]; then
            echo "- ✅ Frontend workflow: ${{ needs.trigger-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "- ❌ Frontend workflow: ${{ needs.trigger-frontend.result }}" >> $GITHUB_STEP_SUMMARY
          fi